import {existsSync} from "fs";
import getPort from "get-port";
import path from "path";
import {z} from "zod";
import {addTrailingSlash} from "./util.js";
const AstroConfigSchema = z.object({
  projectRoot: z.string().optional().default(".").transform((val) => new URL(val)),
  src: z.string().optional().default("./src").transform((val) => new URL(val)),
  pages: z.string().optional().default("./src/pages").transform((val) => new URL(val)),
  public: z.string().optional().default("./public").transform((val) => new URL(val)),
  dist: z.string().optional().default("./dist").transform((val) => new URL(val)),
  renderers: z.array(z.string()).optional().default(["@astrojs/renderer-svelte", "@astrojs/renderer-vue", "@astrojs/renderer-react", "@astrojs/renderer-preact"]),
  markdownOptions: z.object({
    footnotes: z.boolean().optional(),
    gfm: z.boolean().optional(),
    remarkPlugins: z.array(z.any()).optional(),
    rehypePlugins: z.array(z.any()).optional()
  }).optional().default({}),
  buildOptions: z.object({
    site: z.string().optional(),
    sitemap: z.boolean().optional().default(true),
    pageUrlFormat: z.union([z.literal("file"), z.literal("directory")]).optional().default("directory")
  }).optional().default({}),
  devOptions: z.object({
    hostname: z.string().optional().default("localhost"),
    port: z.number().optional().transform((val) => val || getPort({port: getPort.makeRange(3e3, 3050)})),
    tailwindConfig: z.string().optional(),
    trailingSlash: z.union([z.literal("always"), z.literal("never"), z.literal("ignore")]).optional().default("ignore")
  }).optional().default({})
});
async function validateConfig(userConfig, root) {
  const fileProtocolRoot = `file://${root}/`;
  const AstroConfigRelativeSchema = AstroConfigSchema.extend({
    projectRoot: z.string().default(".").transform((val) => new URL(addTrailingSlash(val), fileProtocolRoot)),
    src: z.string().default("./src").transform((val) => new URL(addTrailingSlash(val), fileProtocolRoot)),
    pages: z.string().default("./src/pages").transform((val) => new URL(addTrailingSlash(val), fileProtocolRoot)),
    public: z.string().default("./public").transform((val) => new URL(addTrailingSlash(val), fileProtocolRoot)),
    dist: z.string().default("./dist").transform((val) => new URL(addTrailingSlash(val), fileProtocolRoot))
  });
  return AstroConfigRelativeSchema.parseAsync(userConfig);
}
async function loadConfig(rawRoot, configFileName = "astro.config.mjs") {
  const root = rawRoot ? path.resolve(rawRoot) : process.cwd();
  const astroConfigPath = new URL(`./${configFileName}`, `file://${root}/`);
  let userConfig = {};
  if (existsSync(astroConfigPath)) {
    userConfig = (await import(astroConfigPath.href)).default;
  }
  const config = await validateConfig(userConfig, root);
  return config;
}
export {
  AstroConfigSchema,
  loadConfig
};
//# sourceMappingURL=data:application/json;base64,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
