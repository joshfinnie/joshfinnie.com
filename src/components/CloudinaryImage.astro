---
import { getCloudinaryImageUrl } from '@lib/cloudinary';

interface Props {
  publicId: string;
  alt: string;
  width?: number;
  height?: number;
  class?: string;
  loading?: 'eager' | 'lazy';
}

const { publicId, alt, width, height, class: className, loading = 'lazy' } = Astro.props;

// Generate optimized Cloudinary URL
const imageUrl = getCloudinaryImageUrl(publicId, {
  ...(width !== undefined && { width }),
  ...(height !== undefined && { height }),
});

// Generate responsive srcset, preserving aspect ratio when height is specified
const aspectRatio = width && height ? height / width : undefined;
function srcsetEntry(w: number) {
  const h = aspectRatio ? Math.round(w * aspectRatio) : undefined;
  return `${getCloudinaryImageUrl(publicId, { width: w, ...(h !== undefined && { height: h }) })} ${w}w`;
}
const baseWidth = width || 800;
const srcset = [
  srcsetEntry(Math.round(baseWidth / 2)),
  srcsetEntry(baseWidth),
  srcsetEntry(Math.round(baseWidth * 1.5)),
  srcsetEntry(baseWidth * 2),
].join(', ');

const sizes = width
  ? `(max-width: ${width}px) 100vw, ${width}px`
  : '(max-width: 768px) 100vw, (max-width: 1200px) 80vw, 1200px';
---

<img
  src={imageUrl}
  srcset={srcset}
  sizes={sizes}
  alt={alt}
  width={width}
  height={height}
  class={className}
  loading={loading}
  decoding="async"
/>
