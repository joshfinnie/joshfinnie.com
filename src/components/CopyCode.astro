<script>
  import COPY_ICON from '@icons/mc_copy_line.svg?raw';
  import CHECK_ICON from '@icons/mc_check_line.svg?raw';

  for (const pre of document.querySelectorAll('pre.astro-code')) {
    const wrapper = document.createElement('div');
    wrapper.className = 'code-block-wrapper';
    pre.parentNode?.insertBefore(wrapper, pre);
    wrapper.appendChild(pre);

    const bar = document.createElement('div');
    bar.className = 'code-block-bar';

    const lang = pre.getAttribute('data-language');
    if (lang) {
      const label = document.createElement('span');
      label.className = 'code-block-lang';
      label.textContent = lang;
      bar.appendChild(label);
    }

    const button = document.createElement('button');
    button.type = 'button';
    button.setAttribute('aria-label', 'Copy code');
    button.className = 'code-block-copy';
    button.innerHTML = COPY_ICON;

    button.addEventListener('click', async () => {
      const text = pre.querySelector('code')?.innerText ?? '';
      await navigator.clipboard.writeText(text);
      button.innerHTML = CHECK_ICON;
      button.setAttribute('data-copied', '');
      setTimeout(() => {
        button.innerHTML = COPY_ICON;
        button.removeAttribute('data-copied');
      }, 2000);
    });

    bar.appendChild(button);
    wrapper.insertBefore(bar, pre);
  }
</script>

<style is:global>
  .code-block-wrapper {
    position: relative;
  }

  .code-block-wrapper pre.astro-code {
    border-radius: 0 0 0.375rem 0.375rem !important;
    margin-top: 0 !important;
  }

  .code-block-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.25rem 0.75rem;
    border-radius: 0.375rem 0.375rem 0 0;
    background-color: #e4e8ec;
    border-bottom: 1px solid #d0d7de;
  }

  .dark .code-block-bar {
    background-color: #2d333b;
    border-bottom-color: #444c56;
  }

  .code-block-lang {
    font-size: 0.75rem;
    font-family: ui-monospace, monospace;
    color: #57606a;
  }

  .dark .code-block-lang {
    color: #768390;
  }

  .code-block-copy {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.2rem;
    border-radius: 0.25rem;
    border: none;
    background: transparent;
    color: #57606a;
    cursor: pointer;
    transition: color 0.15s, background-color 0.15s;
  }

  .dark .code-block-copy {
    color: #768390;
  }

  .code-block-copy:hover {
    background-color: rgba(0, 0, 0, 0.08);
    color: #24292f;
  }

  .dark .code-block-copy:hover {
    background-color: rgba(255, 255, 255, 0.08);
    color: #cdd9e5;
  }

  .code-block-copy[data-copied] {
    color: #1a7f37;
  }

  .dark .code-block-copy[data-copied] {
    color: #57ab5a;
  }
</style>
